<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vigara Production</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f9fafb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --text:#111827;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
      background:var(--bg);
      color:var(--text);
    }
    .app{display:flex;min-height:100vh}
    .sidebar{
      width:260px;
      background:var(--card);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow:2px 0 8px rgba(0,0,0,0.1);
    }
    .brand{
      font-weight:700;
      letter-spacing:1px;
      font-size:18px;
      margin-bottom:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    #closeSidebar{
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
      display:none;
      color:var(--muted);
    }
    .menu{flex:1}
    .menu button{
      width:100%;
      background:transparent;
      border:none;
      color:var(--muted);
      padding:10px 12px;
      text-align:left;
      border-radius:8px;
      cursor:pointer;
      font-size:15px;
      transition:background 0.2s,color 0.2s;
    }
    .menu button:hover{background:rgba(0,0,0,0.05)}
    .menu button.active{
      background:var(--accent);
      color:#fff;
    }
    .main{flex:1;padding:20px;display:flex;flex-direction:column;gap:16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .card{
      background:var(--card);
      padding:16px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column:span 4}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #e5e7eb}
    th{font-size:13px;color:var(--muted)}
    td{font-size:14px}
    .login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .login-card{
      width:100%;max-width:420px;padding:28px;border-radius:12px;
      background:var(--card);box-shadow:0 4px 20px rgba(0,0,0,0.1)
    }
    .field{display:flex;flex-direction:column;margin-bottom:12px}
    .field input{
      padding:10px;border-radius:8px;border:1px solid #d1d5db;
      background:#fff;color:var(--text)
    }
    .btn{
      background:var(--accent);color:#fff;padding:10px 14px;
      border:none;border-radius:8px;cursor:pointer
    }
    .btn:hover{opacity:.9}
    .muted{color:var(--muted)}
    .online-list{display:flex;flex-direction:column;gap:8px}
    .person{display:flex;align-items:center;gap:8px}
    .avatar{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(180deg,#2dd4bf,#06b6d4);
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff
    }

    /* Responsive Sidebar */
    @media (max-width:900px){
      .sidebar{
        position:fixed;
        top:0;left:-100%;
        width:80%;max-width:260px;
        height:100%;background:var(--card);
        transition:left .3s ease;
        z-index:1000;
      }
      .sidebar.open{left:0}
      .main{padding:12px}
      #closeSidebar{display:block;} /* tombol X hanya muncul di mobile */
    }

    /* Grid jadi 1 kolom di HP */
    @media (max-width:768px){
      .grid{grid-template-columns:1fr}
      .col-4,.col-8,.col-12{grid-column:span 1}
      .topbar{flex-direction:column;align-items:flex-start}
      .topbar h2{font-size:18px}
      .btn{padding:12px 16px;font-size:15px}
    }

    @media (max-width:520px){.login-card{padding:18px}}

    /* Loading Spinner */
    #loadingOverlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(255,255,255,0.8);display:none;
      align-items:center;justify-content:center;z-index:2000;
    }
    #loadingOverlay .spinner{
      border:4px solid #e5e7eb;
      border-top:4px solid var(--accent);
      border-radius:50%;width:40px;height:40px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="loginPage" class="login-wrap">
    <div class="login-card card">
      <h2>Login Peserta</h2>
      <div class="field"><label>Username</label><input id="username"/></div>
      <div class="field"><label>Password</label><input id="password" type="password"/></div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input id="remember" type="checkbox"/><label for="remember">Ingat saya</label>
      </div>
      <button id="loginBtn" class="btn">Login</button>
      <p id="loginMsg" class="muted" style="margin-top:12px"></p>
    </div>
  </div>

  <div id="app" class="app" style="display:none">
    <aside class="sidebar card">
      <div class="brand">
        <span>Vigara Production</span>
        <button id="closeSidebar">✕</button>
      </div>
      <div class="menu" id="menuList">
        <button class="active" data-view="dashboard">Dashboard</button>
        <button data-view="absen">Tampilan Absen</button>
        <button data-view="keuangan">Tampilan Keuangan</button>
        <button data-view="seleksi">Tampilan Seleksi PPCAB</button>
        <button data-view="(Pemdi)Vigpro">Pemilihan Umum Ketua Vigpro</button>
      </div>
      <div style="margin-top:auto;font-size:12px;color:var(--muted)">Menu Anggota</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <button id="menuToggle" class="btn" style="background:var(--accent)">☰</button>
        <div>
          <h2 id="greeting">Halo, Peserta</h2>
          <div class="muted" id="userInfo">-</div>
        </div>
        <div>
          <button id="logoutBtn" class="btn" style="background:#ef4444">Logout</button>
        </div>
      </div>

      <div class="grid">
        <section class="card col-8">
          <h3>TOP Anggota Teraktif</h3>
          <canvas id="topChart" style="max-height:260px"></canvas>
          <table id="topTable"><thead><tr><th>Nama</th><th>Skor</th></tr></thead><tbody></tbody></table>
        </section>
        <section class="card col-4">
          <h3>Anggota Online</h3>
          <div class="online-list" id="onlineList"></div>
        </section>
        <section class="card col-12">
          <h3>Pengumuman</h3>
          <div id="announcements">-</div>
        </section>
      </div>
    </main>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay"><div class="spinner"></div></div>

<script>
const CONFIG = {
  API_URL: "https://script.google.com/macros/s/AKfycbxr0BSc8ZPCzodd8CmO_OYCkxKac9FjobP2a8Ekl5fTXtA6RXhgXp8Gv0uP7DqOkK2d/exec"
};

let DATA = { peserta:[], announcements:[] };
let CURRENT_USER=null; let topChart=null;

// ==== AUTO LOGOUT KARENA IDLE ====
let idleTimer=null;
const IDLE_LIMIT=2*60*1000;

function resetIdleTimer(){
  clearTimeout(idleTimer);
  if(CURRENT_USER){
    idleTimer=setTimeout(()=>{
      alert("Anda otomatis logout karena tidak aktif lebih dari 2 menit.");
      logout();
    },IDLE_LIMIT);
  }
}

["click","mousemove","keydown","scroll","touchstart"].forEach(evt=>{
  document.addEventListener(evt, resetIdleTimer, false);
});

// ==== LOGIN & LOGOUT ====
async function loginUser(username,password,remember){
  try{
    const resp=await fetch(`${CONFIG.API_URL}?action=login&username=${username}&password=${password}`);
    const user=await resp.json();
    if(user && user.username){
      CURRENT_USER=user;
      if(remember) localStorage.setItem('siswa_currentUser',JSON.stringify(user));
      onLoginSuccess();
      return true;
    }
  }catch(e){console.error(e)}
  return false;
}

function onLoginSuccess(){
  showApp();
  updateDashboard();
  resetIdleTimer();
}

async function logout(){
  if(CURRENT_USER){ await fetch(`${CONFIG.API_URL}?action=logout&username=${CURRENT_USER.username}`); }
  localStorage.removeItem('siswa_currentUser'); CURRENT_USER=null; showLogin();
}

function showLogin(){
  document.getElementById('loginPage').style.display='flex';
  document.getElementById('app').style.display='none'
}
function showApp(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('app').style.display='flex'
}

document.getElementById('loginBtn').onclick=async()=>{
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value;
  const remember=document.getElementById('remember').checked;
  if(!(await loginUser(u,p,remember))) document.getElementById('loginMsg').textContent="Login gagal";
};
document.getElementById('logoutBtn').onclick=()=>logout();
document.getElementById('menuToggle').onclick=()=>{ document.querySelector('.sidebar').classList.toggle('open'); };
document.getElementById('closeSidebar').onclick=()=>{ document.querySelector('.sidebar').classList.remove('open'); };

function loadRemembered(){
  const saved=localStorage.getItem('siswa_currentUser');
  if(saved){CURRENT_USER=JSON.parse(saved);onLoginSuccess();}
}

// ==== LOAD DATA ====
async function loadFromGoogleSheets(showSpinner=false){
  try{
    if(showSpinner) showLoading(true);
    const pesertaResp=await fetch(`${CONFIG.API_URL}?action=getPeserta`);
    DATA.peserta=await pesertaResp.json();
    const annResp=await fetch(`${CONFIG.API_URL}?action=getAnnouncements`);
    DATA.announcements=await annResp.json();
    updateDashboard();
  }catch(e){console.error(e)}
  finally{
    if(showSpinner) showLoading(false);
  }
}

function updateDashboard(){
  if(CURRENT_USER){
    document.getElementById('greeting').textContent=`Halo, ${CURRENT_USER.name}`;
    document.getElementById('userInfo').textContent=`Username: ${CURRENT_USER.username} | Role: ${CURRENT_USER.role || "-"}`;
  }
  const top=[...DATA.peserta].sort((a,b)=>b.activeScore-a.activeScore).slice(0,5);
  const labels=top.map(t=>t.name), values=top.map(t=>Number(t.activeScore));
  const ctx=document.getElementById('topChart').getContext('2d'); if(topChart) topChart.destroy();
  topChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Aktif',data:values,backgroundColor:varAccent()}]},options:{plugins:{legend:{display:false}}}});
  const tbody=document.querySelector('#topTable tbody'); tbody.innerHTML='';
  [...DATA.peserta].sort((a,b)=>b.score-a.score).forEach(p=>{tbody.innerHTML+=`<tr><td>${p.name}</td><td>${p.score}</td></tr>`});
  const annDiv=document.getElementById('announcements'); annDiv.innerHTML='';
  DATA.announcements.forEach(a=>{annDiv.innerHTML+=`<div><strong>${a.title}</strong> (${a.date})<div>${a.desc}</div></div><hr/>`});
  const online=DATA.peserta.filter(p=>(p.online+"").toLowerCase()==="true");
  const list=document.getElementById('onlineList'); list.innerHTML='';
  online.forEach(p=>{list.innerHTML+=`<div class='person'><div class='avatar'>${p.name.split(' ').map(s=>s[0]).join('')}</div><div><strong>${p.name}</strong><div class='muted'>${p.username}</div></div></div>`});
}

function varAccent(){return getComputedStyle(document.documentElement).getPropertyValue('--accent');}

function showLoading(show=true){
  document.getElementById('loadingOverlay').style.display=show?"flex":"none";
}

// === AUTO REFRESH TANPA SPINNER ===
setInterval(()=>loadFromGoogleSheets(false),10000);

loadRemembered();
loadFromGoogleSheets(true); // pertama kali tampilkan spinner

// ==== MENU EVENT (cek role saat keuangan) ====
document.querySelectorAll('#menuList button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const view=btn.dataset.view;

    if(view==="keuangan"){
      if(CURRENT_USER && CURRENT_USER.role==="admin"){
        window.location.href="uangedit.html";
      }else{
        window.location.href="kas.html";
      }
      return;
    }

    if(view==="absen"){
      window.location.href="absen.html"; // <-- buka halaman absen
      return;
    }

    if(view==="seleksi"){
      window.location.href="https://docs.google.com/spreadsheets/d/1Xhrr2cCN4ykeX5RcgNAt_oMcCO9TzkkzFHaz42QwjS4/edit?usp=sharing"; // <-- ganti dengan link Anda
      return;
    }

    if(view==="(Pemdi)Vigpro"){
      window.location.href="pemdi.html"; // <-- buka halaman absen
      return;
    }

    // default: hanya aktifkan menu
    document.querySelectorAll('#menuList button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});
</script>
</body>
</html>