<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KAS Anggota</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:"Poppins",sans-serif; margin:20px; background:#eef2f7; }
    h1 { text-align:center; margin-bottom:25px; color:#333; font-size: 24px; }
    .container { max-width:1000px; margin:auto; background:#fff; padding:25px; border-radius:15px; box-shadow:0 6px 15px rgba(0,0,0,.1); }

    .kpi { display:flex; gap:20px; justify-content:space-around; margin-top:20px; flex-wrap:wrap; }
    .card { flex:1; min-width:180px; padding:20px; border-radius:15px; color:#fff; text-align:center; font-size:16px; font-weight:600; box-shadow:0 4px 10px rgba(0,0,0,.1); transition:0.3s; }
    .card:hover { transform:scale(1.05); }
    .initial { background:linear-gradient(135deg,#ffc107,#ffcd39); }
    .income { background:linear-gradient(135deg,#28a745,#60d394); }
    .expense { background:linear-gradient(135deg,#dc3545,#ff6f61); }
    .balance { background:linear-gradient(135deg,#17a2b8,#4dd0e1); }

    table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; white-space:nowrap; }
    th { background:#007bff; color:#fff; }
    tr:nth-child(even) { background:#f9f9f9; }
    tr:hover { background:#f1f1f1; }
    .status-lunas { background:#28a745; color:#fff; padding:4px 10px; border-radius:8px; font-size:12px; font-weight:600; }
    .status-belum { background:#dc3545; color:#fff; padding:4px 10px; border-radius:8px; font-size:12px; font-weight:600; }

    #loadingOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.85);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999; font-size: 18px; flex-direction: column; color: #333;
      display: none;
    }
    .spinner { border: 6px solid #e0e0e0; border-top: 6px solid #007bff; border-radius: 50%;
      width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Responsif */
    @media (max-width: 768px) {
      body { margin: 10px; }
      h1 { font-size: 20px; }
      .container { padding: 15px; border-radius: 10px; }
      .kpi { flex-direction: column; gap: 12px; }
      .card { font-size: 14px; padding: 15px; min-width: auto; border-radius: 12px; }
      table { font-size: 12px; display: block; overflow-x: auto; white-space: nowrap; border-radius: 8px; }
      th, td { padding: 8px; }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div>‚è≥ Memuat data, harap tunggu...</div>
  </div>

  <div class="container">
    <h1>üí∞ Kas Anggota</h1>

    <!-- KPI -->
    <div class="kpi">
      <div class="card initial">Saldo Awal<br><span id="saldoAwal">Rp 0</span></div>
      <div class="card income">Pemasukan<br><span id="totalPemasukan">Rp 0</span></div>
      <div class="card expense">Pengeluaran<br><span id="totalPengeluaran">Rp 0</span></div>
      <div class="card balance">Saldo<br><span id="totalSaldo">Rp 0</span></div>
    </div>

    <!-- Riwayat -->
    <h3>üìë Riwayat Transaksi</h3>
    <table>
      <thead>
        <tr><th>Tanggal</th><th>Nama</th><th>Keterangan</th><th>Debit</th><th>Kredit</th><th>Saldo</th></tr>
      </thead>
      <tbody id="tabelKas"></tbody>
    </table>
    <div style="margin-top:10px;text-align:center;">
      <button onclick="prevPage()">‚¨ÖÔ∏è Prev</button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()">Next ‚û°Ô∏è</button>
    </div>

    <!-- Status Utang -->
    <h3>üí∞ Status Utang Anggota</h3>
    <div id="utangSection">
      <table id="utangTable">
        <thead>
          <tr>
            <th>Nama</th>
            <th>Sudah Bayar</th>
            <th>Total Kewajiban</th>
            <th>Sisa Utang</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tabelUtang"></tbody>
      </table>
    </div>
  </div>

  <script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbwaSCB4r5QfseOPE1CFuO85ffmoO_FJNFdiSREOpiq_FOPsfPG6kdTq6cMaNiOLSLpGPA/exec"; 
  const rupiah = n => 'Rp ' + (Number(n||0)).toLocaleString('id-ID');
  let transaksiData = []; let currentPage = 1; const rowsPerPage = 5;

  function showLoading(show){ document.getElementById("loadingOverlay").style.display = show?"flex":"none"; }

  async function loadData(){
    showLoading(true);
    try {
      const res = await fetch(scriptURL);
      const data = await res.json();
      document.getElementById('saldoAwal').textContent = rupiah(data.saldoAwal);
      document.getElementById('totalPemasukan').textContent = rupiah(data.pemasukan);
      document.getElementById('totalPengeluaran').textContent = rupiah(data.pengeluaran);
      document.getElementById('totalSaldo').textContent = rupiah(data.saldo);

      transaksiData = data.dataKas; currentPage = 1; renderTable();

      const utangBody = document.getElementById('tabelUtang');
      utangBody.innerHTML = '';
      data.statistik.forEach(row=>{
        const status = row.utang<=0 ? `<span class="status-lunas">Lunas</span>` : `<span class="status-belum">Belum</span>`;
        utangBody.innerHTML += `<tr>
          <td>${row.nama}</td>
          <td>${rupiah(row.totalBayar)}</td>
          <td>${rupiah(data.mingguBerjalan * data.iuranMingguan)}</td>
          <td>${rupiah(row.utang)}</td>
          <td>${status}</td>
        </tr>`;
      });
    } catch(err) { alert("‚ö†Ô∏è Gagal memuat data: "+err); } 
    finally { showLoading(false); }
  }

  function renderTable(){
    const tbody = document.getElementById('tabelKas'); tbody.innerHTML = '';
    const start = (currentPage-1)*rowsPerPage; const end = start+rowsPerPage;
    const slice = transaksiData.slice(start,end);
    slice.forEach(r=>{
      tbody.innerHTML += `<tr>
        <td>${r.Tanggal||''}</td>
        <td>${r.Nama||''}</td>
        <td>${r.Keterangan||''}</td>
        <td>${rupiah(r.Debit||0)}</td>
        <td>${rupiah(r.Kredit||0)}</td>
        <td>${rupiah(r.Saldo||0)}</td>
      </tr>`;
    });
    document.getElementById("pageInfo").textContent = "Page "+currentPage+" / "+Math.ceil(transaksiData.length/rowsPerPage);
  }
  function prevPage(){ if(currentPage>1){currentPage--; renderTable();} }
  function nextPage(){ if(currentPage<Math.ceil(transaksiData.length/rowsPerPage)){currentPage++; renderTable();} }

  document.addEventListener("DOMContentLoaded",loadData);
  </script>
</body>
</html>